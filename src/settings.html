<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置</title>
    <link rel="stylesheet" href="./styles/main.css">
    <link href="./styles/settings.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/fontawesome-free-6.7.2/css/all.css">
    <script src="./scripts/toast.js"></script>
    <style>
        /* 简单Toast样式作为备用 */
        .simple-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            background: #10b981;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            animation: simple-slide-in 0.3s forwards;
            max-width: 400px;
        }

        @keyframes simple-slide-in {
            from {
                transform: translateX(120%);
            }
            to {
                transform: translateX(0);
            }
        }

        .simple-toast-error {
            background: #ef4444;
        }

        .simple-toast-warning {
            background: #f59e0b;
        }

        .simple-toast-info {
            background: #3b82f6;
        }
    </style>
</head>
<body>
<div class="settings-container">
    <div class="category-tabs-container">
        <div class="category-tabs">
            <button class="category-tab active" data-category="clipboard">
                <i class="fas fa-clipboard btn-icon"></i> 剪切板设置
            </button>
            <button class="category-tab" data-category="ai">
                <i class="fas fa-robot btn-icon"></i> AI设置
            </button>
            <button class="category-tab" data-category="about">
                <i class="fas fa-info-circle btn-icon"></i> 关于
            </button>
            <button class="theme-toggle-btn" id="themeToggleBtn" title="切换主题">
                <i class="fas fa-moon btn-icon"></i>
                <span class="theme-text">黑夜</span>
            </button>
        </div>
    </div>

    <div class="settings-content">
        <div class="category-content active" id="clipboard-content">
            <form id="clipboardSettingsForm">
                <div class="settings-grid">
                    <div class="form-group">
                        <label class="form-label" for="maxItems">
                            <i class="fas fa-history btn-icon"></i> 最大历史记录数
                        </label>
                        <div class="input-group">
                            <span class="input-icon"><i class="fas fa-list-ol"></i></span>
                            <input class="form-input input-with-icon" id="maxItems" max="1000" min="1"
                                   placeholder="例如: 50"
                                   type="number">
                        </div>
                        <span class="form-hint">设置剪贴板历史记录的最大保存数量 (1-1000)</span>
                    </div>
                </div>
            </form>
        </div>

        <div class="category-content" id="ai-content">
            <form id="aiSettingsForm">
                <div class="settings-grid">
                    <div class="form-group full-width">
                        <label class="form-label" for="apiUrl">
                            <i class="fas fa-server btn-icon"></i> AI服务地址
                        </label>
                        <div class="input-group">
                            <span class="input-icon"><i class="fas fa-link"></i></span>
                            <input class="form-input input-with-icon" id="apiUrl"
                                   placeholder="例如: https://api.openai.com/v1"
                                   type="url">
                            <span class="test-icon" id="testBtn">
                                <i class="fas fa-plug"></i>
                            </span>
                        </div>
                        <span class="form-hint">AI服务的API端点地址</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="modelName">
                            <i class="fas fa-brain btn-icon"></i> AI模型名称
                        </label>
                        <div class="input-group">
                            <span class="input-icon"><i class="fas fa-robot"></i></span>
                            <input class="form-input input-with-icon" id="modelName" placeholder="例如: gpt-3.5-turbo"
                                   type="text">
                        </div>
                        <span class="form-hint">使用的AI模型名称</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="apiKey">
                            <i class="fas fa-key btn-icon"></i> API密钥
                        </label>
                        <div class="input-group">
                            <span class="input-icon"><i class="fas fa-lock"></i></span>
                            <input class="form-input input-with-icon" id="apiKey" placeholder="请输入您的API密钥"
                                   type="text">
                        </div>
                        <span class="form-hint">用于访问AI服务的API密钥</span>
                    </div>
                </div>
                <div class="test-result" id="testResult">
                    <div class="test-result-content">
                        <i class="test-result-icon"></i>
                        <span class="test-result-text"></span>
                    </div>
                </div>
            </form>
        </div>

        <div class="category-content" id="about-content">
            <div class="about-section">
                <h3><i class="fas fa-sync-alt btn-icon"></i> 检查更新</h3>
                <div class="update-section">
                    <p>当前版本：<strong id="currentVersion"></strong></p>
                    <button class="btn btn-warning" id="checkUpdateBtn" type="button">
                        <i class="fas fa-sync-alt btn-icon"></i> 检查更新
                    </button>

                    <div class="update-progress hidden" id="updateProgress">
                        <div class="progress-container">
                            <div class="progress-info">
                                <span id="progressText">正在准备更新...</span>
                                <span id="percentage">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>
                        <div class="status-message">
                            <h4>更新状态</h4>
                            <p id="statusText">正在检查更新...</p>
                        </div>
                        <div class="action-buttons hidden" id="updateActionButtons">
                            <button class="btn btn-primary" id="restartBtn">
                                <i class="fas fa-redo btn-icon"></i> 重启应用
                            </button>
                            <button class="btn btn-secondary" id="closeUpdateBtn">
                                <i class="fas fa-times btn-icon"></i> 关闭
                            </button>
                        </div>
                    </div>

                    <div class="test-result" id="updateResult">
                        <div class="test-result-content">
                            <i class="test-result-icon"></i>
                            <span class="test-result-text"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="about-content">
                <div class="about-section">
                    <h3><i class="fas fa-star btn-icon"></i> 软件功能</h3>
                    <ul class="feature-list">
                        <li><i class="fas fa-clipboard-check"></i> <strong>剪贴板管理</strong> - 自动记录剪贴板历史，支持快速选择和粘贴
                        </li>
                        <li><i class="fas fa-mouse-pointer"></i> <strong>划词翻译</strong> - 选中文本后自动显示翻译和解释选项
                        </li>
                        <li><i class="fas fa-robot"></i> <strong>AI集成</strong> - 支持OpenAI等AI服务，提供智能翻译和解释
                        </li>
                        <li><i class="fas fa-bolt"></i> <strong>快捷键操作</strong> - 支持自定义快捷键，提高工作效率</li>
                        <li><i class="fas fa-history"></i> <strong>历史记录</strong> - 保存剪贴板历史，方便重复使用</li>
                    </ul>
                </div>

                <div class="about-section">
                    <h3><i class="fas fa-book btn-icon"></i> 使用方法</h3>
                    <ol class="usage-list">
                        <li><strong>剪贴板使用</strong>：按 <code>Ctrl+Shift+K</code> 显示剪贴板历史窗口</li>
                        <li><strong>划词功能</strong>：选中文本后显示工具栏</li>
                        <li><strong>AI设置</strong>：在AI设置页面配置API密钥和服务地址</li>
                        <li><strong>更新检查</strong>：点击按钮检查软件更新</li>
                        <li><strong>系统托盘</strong>：右键系统托盘图标访问更多功能</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="save-button-container">
        <button class="btn btn-success" id="saveBtn" type="button">
            <i class="fas fa-save btn-icon"></i>
        </button>
    </div>

    <div class="settings-footer-container">
        <div class="settings-footer">
            <p>需要帮助？<a data-href="https://github.com/zRq1351/fuyun_tools" href="#"
                           onclick="openExternalLink(this.dataset.href); return false;">
                查看文档
            </a> | <a data-href="https://github.com/zRq1351/fuyun_tools/issues" href="#"
                      onclick="openExternalLink(this.dataset.href); return false;">
                报告问题
            </a></p>
            <p id="footer"></p>
        </div>
    </div>
</div>

<script>
    const invoke = window.__TAURI__.core.invoke;
    const {getCurrentWindow} = window.__TAURI__.window;
    const { openPath } = window.__TAURI__.opener
    async function openExternalLink(url) {
        try {
            await openPath(url);
        } catch (err) {
            console.error('打开失败:', err.message || err);
        }
        return false;
    }

    let originalApiKey = '';

    function getMaskedApiKey(apiKey) {
        if (!apiKey || apiKey.length === 0) {
            return '';
        }

        const len = apiKey.length;
        if (len <= 16) {
            return '*'.repeat(Math.min(len, 30));
        }

        const prefix = apiKey.substring(0, 8);
        const suffix = apiKey.substring(len - 8);
        return prefix + '*'.repeat(30) + suffix;
    }

    function isMaskedValue(value) {
        if (!value || value.length === 0) return false;

        const starPattern = /\*{30}/;
        if (!starPattern.test(value)) {
            return false;
        }

        return value.length >= 46;
    }

    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.category-tab').forEach(t => {
                t.classList.remove('active');
            });

            document.querySelectorAll('.category-content').forEach(content => {
                content.classList.remove('active');
            });

            tab.classList.add('active');

            const category = tab.getAttribute('data-category');
            document.getElementById(`${category}-content`).classList.add('active');

            updateTestButtonVisibility(category);

            // 根据当前分类显示/隐藏保存按钮
            const saveBtnContainer = document.querySelector('.save-button-container');
            if (category === 'about') {
                saveBtnContainer.classList.add('hidden');
            } else {
                saveBtnContainer.classList.remove('hidden');
            }
        });
    });

    // 根据分类更新测试按钮可见性
    function updateTestButtonVisibility(category) {
        const testBtn = document.getElementById('testBtn');
        if (category === 'ai') {
            testBtn.style.display = 'inline-flex';
        } else {
            testBtn.style.display = 'none';
        }
    }

    // 初始化时根据当前分类设置测试按钮可见性
    updateTestButtonVisibility('clipboard');
    let maskedKey;
    const year = new Date().getFullYear();
    // 加载设置
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const settings = await invoke('get_ai_settings');

            // 剪切板设置
            document.getElementById('maxItems').value = settings.max_items || 50;
            document.getElementById('currentVersion').innerText = settings.version;
            console.log('当前版本：', settings.version);
            document.getElementById('footer').innerText = `版本 ${settings.version} | © ${year} fuyun_tools`;
            // AI设置
            document.getElementById('apiUrl').value = settings.ai_api_url || '';
            document.getElementById('modelName').value = settings.ai_model_name || '';

            // 保存原始API密钥并显示部分隐藏版本
            originalApiKey = settings.ai_api_key || '';
            maskedKey = getMaskedApiKey(originalApiKey);
            const apiKeyInput = document.getElementById('apiKey');
            apiKeyInput.value = maskedKey;

            apiKeyInput.addEventListener('focus', () => {
                if (apiKeyInput.value === maskedKey && originalApiKey) {
                    apiKeyInput.value = originalApiKey;
                }
            });

            apiKeyInput.addEventListener('blur', () => {
                if (apiKeyInput.value === originalApiKey && originalApiKey) {
                    apiKeyInput.value = maskedKey;
                }
            });

            // 初始化时隐藏关于页面的保存按钮
            const activeTab = document.querySelector('.category-tab.active');
            const category = activeTab.getAttribute('data-category');
            const saveBtnContainer = document.querySelector('.save-button-container');

            if (category === 'about') {
                saveBtnContainer.classList.add('hidden');
            }
        } catch (error) {
            console.error('加载设置失败:', error);
        }
    });

    // 简单Toast函数作为备用
    function showSimpleToast(message, type = 'success') {
        console.log('showSimpleToast called:', message, type);

        // 移除现有的简单toast
        const existingToasts = document.querySelectorAll('.simple-toast');
        existingToasts.forEach(toast => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        });

        // 创建新的toast
        const toast = document.createElement('div');
        toast.className = `simple-toast simple-toast-${type}`;
        toast.textContent = message;

        // 添加到body
        document.body.appendChild(toast);

        // 3秒后自动移除
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);

        return toast;
    }

    // 保存设置
    document.getElementById('saveBtn').addEventListener('click', async () => {
        const maxItems = parseInt(document.getElementById('maxItems').value) || 50;
        const apiUrl = document.getElementById('apiUrl').value;
        const modelName = document.getElementById('modelName').value;
        let apiKey = document.getElementById('apiKey').value;

        const maskedOriginal = getMaskedApiKey(originalApiKey);
        if (apiKey === maskedOriginal && originalApiKey) {
            apiKey = originalApiKey;
        } else if (isMaskedValue(apiKey) && originalApiKey) {
            apiKey = originalApiKey;
        }

        try {
            await invoke('save_ai_settings', {
                maxItems: maxItems,
                aiApiUrl: apiUrl,
                aiModelName: modelName,
                aiApiKey: apiKey
            });

            originalApiKey = apiKey;

            document.getElementById('apiKey').value = getMaskedApiKey(originalApiKey);
            maskedKey = getMaskedApiKey(originalApiKey);

            // 确保toast组件已初始化
            if (window.Toast && typeof window.Toast.init === 'function') {
                window.Toast.init();
            }

            // 尝试多种方式显示提示
            console.log('保存成功，尝试显示提示...');
            console.log('window.showSuccessToast exists:', typeof window.showSuccessToast);
            console.log('window.Toast exists:', typeof window.Toast);

            let toastShown = false;

            // 方式1: 使用window.showSuccessToast
            if (window.showSuccessToast && typeof window.showSuccessToast === 'function') {
                try {
                    console.log('尝试使用window.showSuccessToast');
                    window.showSuccessToast('设置已保存');
                    toastShown = true;
                } catch (e) {
                    console.error('window.showSuccessToast失败:', e);
                }
            }

            // 方式2: 使用window.Toast.success
            if (!toastShown && window.Toast && typeof window.Toast.success === 'function') {
                try {
                    console.log('尝试使用window.Toast.success');
                    window.Toast.success('设置已保存');
                    toastShown = true;
                } catch (e) {
                    console.error('window.Toast.success失败:', e);
                }
            }

            // 方式3: 使用简单Toast
            if (!toastShown) {
                console.log('使用简单Toast');
                showSimpleToast('设置已保存', 'success');
                toastShown = true;
            }

            // 方式4: 最后回退到showTestResult
            if (!toastShown) {
                console.log('回退到showTestResult');
                showTestResult('设置已保存', 'success');
            }

        } catch (error) {
            console.error('保存设置失败:', error);

            // 确保toast组件已初始化
            if (window.Toast && typeof window.Toast.init === 'function') {
                window.Toast.init();
            }

            // 错误提示
            let errorToastShown = false;

            // 方式1: 使用window.showErrorToast
            if (window.showErrorToast && typeof window.showErrorToast === 'function') {
                try {
                    window.showErrorToast(`保存失败: ${error}`);
                    errorToastShown = true;
                } catch (e) {
                    console.error('window.showErrorToast失败:', e);
                }
            }

            // 方式2: 使用简单Toast
            if (!errorToastShown) {
                showSimpleToast(`保存失败: ${error}`, 'error');
                errorToastShown = true;
            }

            // 方式3: 最后回退到showTestResult
            if (!errorToastShown) {
                showTestResult(`保存失败: ${error}`, 'error');
            }
        }
    });

    // 测试连接
    document.getElementById('testBtn').addEventListener('click', async () => {
        const apiUrl = document.getElementById('apiUrl').value;
        const modelName = document.getElementById('modelName').value;
        let apiKey = document.getElementById('apiKey').value;

        const maskedOriginal = getMaskedApiKey(originalApiKey);
        if (apiKey === maskedOriginal && originalApiKey) {
            apiKey = originalApiKey;
        } else if (isMaskedValue(apiKey) && originalApiKey) {
            apiKey = originalApiKey;
        }

        if (!apiUrl || !modelName || !apiKey) {
            showTestResult('请填写完整信息后再测试', 'error');
            return;
        }

        try {
            showTestResult('等待响应......', 'error');
            const testResult = await invoke('test_ai_connection', {
                aiApiUrl: apiUrl,
                aiModelName: modelName,
                aiApiKey: apiKey
            });

            showTestResult(testResult, 'success');
        } catch (error) {
            showTestResult(`检查密钥、地址、模型名称是否正确。查看对应模型官方文档`, 'error');
        }
    });

    function showTestResult(message, type) {
        const resultDiv = document.getElementById('testResult');
        const resultIcon = resultDiv.querySelector('.test-result-icon');
        const resultText = resultDiv.querySelector('.test-result-text');

        if (type === 'success') {
            resultIcon.className = 'test-result-icon fas fa-check-circle';
        } else {
            resultIcon.className = 'test-result-icon fas fa-exclamation-circle';
        }

        resultText.textContent = message;

        resultDiv.className = `test-result ${type}`;
        resultDiv.style.display = 'block';

        if (type === 'success') {
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 2000);
        }
    }

    // 检查更新功能
    document.getElementById('checkUpdateBtn').addEventListener('click', async () => {
        const checkUpdateBtn = document.getElementById('checkUpdateBtn');
        const originalText = checkUpdateBtn.innerHTML;

        try {
            checkUpdateBtn.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i> 检查中...';
            checkUpdateBtn.disabled = true;

            document.getElementById('updateResult').style.display = 'none';
            document.getElementById('updateProgress').classList.remove('hidden');

            resetUpdateProgress();

            const hasUpdate = await invoke('check_for_updates');

            if (hasUpdate) {
                showUpdateResult('发现新版本，已开始下载更新', 'success');
                setupUpdateProgressListeners();
            } else {
                showUpdateResult('已是最新版本', 'success');
                hideUpdateProgress();
            }
        } catch (error) {
            console.error('检查更新失败:', error);
            showUpdateResult(`检查更新失败请重试！`, 'error');
            hideUpdateProgress();
        } finally {
            checkUpdateBtn.innerHTML = originalText;
            checkUpdateBtn.disabled = false;
        }
    });

    // 重启按钮事件
    document.getElementById('restartBtn').addEventListener('click', async () => {
        try {
            await invoke('restart_app');
        } catch (error) {
            console.error('重启失败:', error);
            document.getElementById('statusText').textContent = '重启失败，请手动重启应用。';
        }
    });

    // 关闭更新进度按钮事件
    document.getElementById('closeUpdateBtn').addEventListener('click', () => {
        hideUpdateProgress();
    });

    function resetUpdateProgress() {
        document.getElementById('progressText').textContent = '正在准备更新...';
        document.getElementById('percentage').textContent = '0%';
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('statusText').textContent = '正在检查更新...';
        document.getElementById('updateActionButtons').classList.add('hidden');
    }

    function hideUpdateProgress() {
        document.getElementById('updateProgress').classList.add('hidden');
    }

    function setupUpdateProgressListeners() {
        const {listen} = window.__TAURI__.event;

        listen('update-started', () => {
            document.getElementById('progressText').textContent = '开始下载更新...';
            document.getElementById('statusText').textContent = '正在下载新版本文件，请稍候...';
        });

        listen('update-progress', (event) => {
            const progress = event.payload;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('percentage').textContent = `${progress}%`;
            document.getElementById('progressText').textContent = `下载进度: ${progress}%`;

            if (progress === 100) {
                document.getElementById('statusText').textContent = '下载完成，正在准备安装...';
            }
        });

        listen('update-download-complete', () => {
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('percentage').textContent = '100%';
            document.getElementById('progressText').textContent = '下载完成';
            document.getElementById('statusText').textContent = '更新下载完成，正在安装...';

            setTimeout(() => {
                document.getElementById('updateActionButtons').classList.remove('hidden');
                document.getElementById('statusText').textContent = '更新安装完成！请重启应用以使用新版本。';
            }, 2000);
        });
    }

    function showUpdateResult(message, type) {
        const resultDiv = document.getElementById('updateResult');
        const resultIcon = resultDiv.querySelector('.test-result-icon');
        const resultText = resultDiv.querySelector('.test-result-text');

        if (type === 'success') {
            resultIcon.className = 'test-result-icon fas fa-check-circle';
        } else {
            resultIcon.className = 'test-result-icon fas fa-exclamation-circle';
        }

        resultText.textContent = message;

        resultDiv.className = `test-result ${type}`;
        resultDiv.style.display = 'block';

        if (type === 'success') {
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }
    }

    // 主题切换功能
    document.getElementById('themeToggleBtn').addEventListener('click', () => {
        const body = document.body;
        const themeBtn = document.getElementById('themeToggleBtn');
        const icon = themeBtn.querySelector('.btn-icon');
        const text = themeBtn.querySelector('.theme-text');

        if (body.classList.contains('dark-theme')) {
            // 切换到白天主题
            body.classList.remove('dark-theme');
            icon.className = 'fas fa-moon btn-icon';
            text.textContent = '黑夜';
            localStorage.setItem('settings-theme', 'light');
        } else {
            // 切换到黑夜主题
            body.classList.add('dark-theme');
            icon.className = 'fas fa-sun btn-icon';
            text.textContent = '白天';
            localStorage.setItem('settings-theme', 'dark');
        }
    });

    // 初始化主题
    document.addEventListener('DOMContentLoaded', () => {
        // 检查本地存储中的主题偏好
        const savedTheme = localStorage.getItem('settings-theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        // 默认使用白天主题，如果有保存的偏好则使用保存的，否则根据系统偏好
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.body.classList.add('dark-theme');
            const themeBtn = document.getElementById('themeToggleBtn');
            const icon = themeBtn.querySelector('.btn-icon');
            const text = themeBtn.querySelector('.theme-text');
            icon.className = 'fas fa-sun btn-icon';
            text.textContent = '白天';
        }
    });
</script>
</body>
</html>
