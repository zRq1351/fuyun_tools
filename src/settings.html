<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置</title>
    <link href="./styles/settings.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/fontawesome-free-6.7.2/css/all.css">
    <link href="./styles/toast.css" rel="stylesheet">
</head>
<body>
<div class="settings-container">
    <div class="category-tabs-container">
        <div class="category-tabs">
            <button class="category-tab active" data-category="clipboard">
                <i class="fas fa-clipboard btn-icon"></i> 剪切板设置
            </button>
            <button class="category-tab" data-category="ai">
                <i class="fas fa-robot btn-icon"></i> AI设置
            </button>
            <button class="category-tab" data-category="about">
                <i class="fas fa-info-circle btn-icon"></i> 关于
            </button>
            <button class="theme-toggle-btn" id="themeToggleBtn" title="切换主题">
                <i class="fas fa-moon btn-icon"></i>
                <span class="theme-text">黑夜</span>
            </button>
        </div>
    </div>

    <div class="settings-content">
        <div class="category-content active" id="clipboard-content">
            <form id="clipboardSettingsForm">
                <div class="settings-grid">
                    <div class="form-group">
                        <label class="form-label" for="maxItems">
                            <i class="fas fa-history btn-icon"></i> 最大历史记录数
                        </label>
                        <div class="input-group">
                            <span class="input-icon"><i class="fas fa-list-ol"></i></span>
                            <input class="form-input input-with-icon" id="maxItems" max="1000" min="1"
                                   placeholder="例如: 50"
                                   type="number">
                        </div>
                        <span class="form-hint">设置剪贴板历史记录的最大保存数量 (1-1000)</span>
                    </div>
                </div>
            </form>
        </div>

        <div class="category-content" id="ai-content">
            <form id="aiSettingsForm">
                <div class="settings-grid">
                    <div class="form-group full-width">
                        <label class="form-label" for="apiUrl">
                            <i class="fas fa-server btn-icon"></i> AI服务地址
                        </label>
                        <div class="input-group">
                            <span class="input-icon"><i class="fas fa-link"></i></span>
                            <input class="form-input input-with-icon" id="apiUrl"
                                   placeholder="例如: https://api.openai.com/v1"
                                   type="url">
                            <span class="test-icon" id="testBtn">
                                <i class="fas fa-plug"></i>
                            </span>
                        </div>
                        <span class="form-hint">AI服务的API端点地址</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="modelName">
                            <i class="fas fa-brain btn-icon"></i> AI模型名称
                        </label>
                        <div class="input-group">
                            <span class="input-icon"><i class="fas fa-robot"></i></span>
                            <input class="form-input input-with-icon" id="modelName" placeholder="例如: gpt-3.5-turbo"
                                   type="text">
                        </div>
                        <span class="form-hint">使用的AI模型名称</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="apiKey">
                            <i class="fas fa-key btn-icon"></i> API密钥
                        </label>
                        <div class="input-group">
                            <span class="input-icon"><i class="fas fa-lock"></i></span>
                            <input class="form-input input-with-icon" id="apiKey" placeholder="请输入您的API密钥"
                                   type="text">
                        </div>
                        <span class="form-hint">用于访问AI服务的API密钥</span>
                    </div>
                </div>
                <div class="test-result" id="testResult">
                    <div class="test-result-content">
                        <i class="test-result-icon"></i>
                        <span class="test-result-text"></span>
                    </div>
                </div>
            </form>
        </div>

        <div class="category-content" id="about-content">
            <div class="about-section">
                <h3><i class="fas fa-sync-alt btn-icon"></i> 检查更新</h3>
                <div class="update-section">
                    <p>当前版本：<strong id="currentVersion"></strong></p>
                    <button class="btn btn-warning" id="checkUpdateBtn" type="button">
                        <i class="fas fa-sync-alt btn-icon"></i> 检查更新
                    </button>

                    <div class="update-progress hidden" id="updateProgress">
                        <div class="status-message">
                            <h4>更新状态</h4>
                            <p id="statusText">正在检查更新...</p>
                        </div>
                        <div class="action-buttons hidden" id="updateActionButtons">
                            <button class="btn btn-secondary" id="closeUpdateBtn">
                                <i class="fas fa-times btn-icon"></i> 关闭
                            </button>
                        </div>
                    </div>

                    <div class="test-result" id="updateResult">
                        <div class="test-result-content">
                            <i class="test-result-icon"></i>
                            <span class="test-result-text"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="about-content">
                <div class="about-section">
                    <h3><i class="fas fa-star btn-icon"></i> 软件功能</h3>
                    <ul class="feature-list">
                        <li><i class="fas fa-clipboard-check"></i> <strong>剪贴板管理</strong> - 自动记录剪贴板历史，支持快速选择和粘贴
                        </li>
                        <li><i class="fas fa-mouse-pointer"></i> <strong>划词翻译</strong> - 选中文本后自动显示翻译和解释选项
                        </li>
                        <li><i class="fas fa-robot"></i> <strong>AI集成</strong> - 支持OpenAI等AI服务，提供智能翻译和解释
                        </li>
                        <li><i class="fas fa-bolt"></i> <strong>快捷键操作</strong> - 支持自定义快捷键，提高工作效率</li>
                        <li><i class="fas fa-history"></i> <strong>历史记录</strong> - 保存剪贴板历史，方便重复使用</li>
                    </ul>
                </div>

                <div class="about-section">
                    <h3><i class="fas fa-book btn-icon"></i> 使用方法</h3>
                    <ol class="usage-list">
                        <li><strong>剪贴板使用</strong>：按 <code>Ctrl+Shift+K</code> 显示剪贴板历史窗口</li>
                        <li><strong>划词功能</strong>：选中文本后显示工具栏</li>
                        <li><strong>AI设置</strong>：在AI设置页面配置API密钥和服务地址</li>
                        <li><strong>更新检查</strong>：点击按钮检查软件更新</li>
                        <li><strong>系统托盘</strong>：右键系统托盘图标访问更多功能</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="save-button-container">
        <button class="btn btn-success" id="saveBtn" type="button">
            <i class="fas fa-save btn-icon"></i>
        </button>
    </div>

    <div class="settings-footer-container">
        <div class="settings-footer">
            <p>
                需要帮助？
                <a class="external-link" data-href="https://github.com/zRq1351/fuyun_tools">查看文档</a>
                |
                <a class="external-link" data-href="https://github.com/zRq1351/fuyun_tools/issues">报告问题</a>
            </p>
            <p id="footer"></p>
        </div>
    </div>
</div>
<script src="./scripts/main.js"></script>
<script src="./scripts/toast.js"></script>
<script>
    const invoke = window.__TAURI__.core.invoke;
    const {listen} = window.__TAURI__.event;
    const {openUrl} = window.__TAURI__.opener
    document.addEventListener('DOMContentLoaded', async () => {
        const year = new Date().getFullYear();
        let maskedKey;
        let originalApiKey = '';
        window.Toast.init();

        async function openExternalLink(url) {
            try {
                await openUrl(url);
            } catch (err) {
                console.error(err);
            }
            return false;
        }

        function getMaskedApiKey(apiKey) {
            if (!apiKey || apiKey.length === 0) {
                return '';
            }

            const len = apiKey.length;
            if (len <= 16) {
                return '*'.repeat(Math.min(len, 30));
            }

            const prefix = apiKey.substring(0, 8);
            const suffix = apiKey.substring(len - 8);
            return prefix + '*'.repeat(30) + suffix;
        }

        function isMaskedValue(value) {
            if (!value || value.length === 0) return false;

            const starPattern = /\*{30}/;
            if (!starPattern.test(value)) {
                return false;
            }

            return value.length >= 46;
        }

        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.category-tab').forEach(t => {
                    t.classList.remove('active');
                });

                document.querySelectorAll('.category-content').forEach(content => {
                    content.classList.remove('active');
                });

                tab.classList.add('active');

                const category = tab.getAttribute('data-category');
                document.getElementById(`${category}-content`).classList.add('active');

                updateTestButtonVisibility(category);

                const saveBtnContainer = document.querySelector('.save-button-container');
                if (category === 'about') {
                    saveBtnContainer.classList.add('hidden');
                } else {
                    saveBtnContainer.classList.remove('hidden');
                }
            });
        });

        // 根据分类更新测试按钮可见性
        function updateTestButtonVisibility(category) {
            const testBtn = document.getElementById('testBtn');
            if (category === 'ai') {
                testBtn.style.display = 'inline-flex';
            } else {
                testBtn.style.display = 'none';
            }
        }

        updateTestButtonVisibility('clipboard');
        try {
            const settings = await invoke('get_ai_settings');

            // 剪切板设置
            document.getElementById('maxItems').value = settings.max_items || 50;
            document.getElementById('currentVersion').innerText = settings.version;
            console.log('当前版本：', settings.version);
            document.getElementById('footer').innerText = `版本 ${settings.version} | © ${year} fuyun_tools`;
            // AI设置
            document.getElementById('apiUrl').value = settings.ai_api_url || '';
            document.getElementById('modelName').value = settings.ai_model_name || '';
            // 保存原始API密钥并显示部分隐藏版本
            originalApiKey = settings.ai_api_key || '';
            maskedKey = getMaskedApiKey(originalApiKey);
            const apiKeyInput = document.getElementById('apiKey');
            apiKeyInput.value = maskedKey;

            apiKeyInput.addEventListener('focus', () => {
                if (apiKeyInput.value === maskedKey && originalApiKey) {
                    apiKeyInput.value = originalApiKey;
                }
            });

            apiKeyInput.addEventListener('blur', () => {
                if (apiKeyInput.value === originalApiKey && originalApiKey) {
                    apiKeyInput.value = maskedKey;
                }
            });

            // 初始化时隐藏关于页面的保存按钮
            const activeTab = document.querySelector('.category-tab.active');
            const category = activeTab.getAttribute('data-category');
            const saveBtnContainer = document.querySelector('.save-button-container');

            if (category === 'about') {
                saveBtnContainer.classList.add('hidden');
            }
        } catch (error) {
            console.error('加载设置失败:', error);
        }

        document.querySelectorAll('.external-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const url = link.dataset.href;
                openExternalLink(url);
            });
        });

        const savedTheme = localStorage.getItem('settings-theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.body.classList.add('dark-theme');
            const themeBtn = document.getElementById('themeToggleBtn');
            const icon = themeBtn.querySelector('.btn-icon');
            const text = themeBtn.querySelector('.theme-text');
            icon.className = 'fas fa-sun btn-icon';
            text.textContent = '白天';
        }

        document.getElementById('saveBtn').addEventListener('click', async () => {
            const maxItems = parseInt(document.getElementById('maxItems').value) || 50;
            const apiUrl = document.getElementById('apiUrl').value;
            const modelName = document.getElementById('modelName').value;
            let apiKey = document.getElementById('apiKey').value;

            const maskedOriginal = getMaskedApiKey(originalApiKey);
            if (apiKey === maskedOriginal && originalApiKey) {
                apiKey = originalApiKey;
            } else if (isMaskedValue(apiKey) && originalApiKey) {
                apiKey = originalApiKey;
            }

            try {
                await invoke('save_ai_settings', {
                    maxItems: maxItems,
                    aiApiUrl: apiUrl,
                    aiModelName: modelName,
                    aiApiKey: apiKey
                });
                originalApiKey = apiKey;
                document.getElementById('apiKey').value = getMaskedApiKey(originalApiKey);
                maskedKey = getMaskedApiKey(originalApiKey);
                window.showSuccessToast('保存成功');
            } catch (error) {
                window.showErrorToast(`保存失败: ${error}`);
            }
        });

        // 测试连接
        document.getElementById('testBtn').addEventListener('click', async () => {
            const apiUrl = document.getElementById('apiUrl').value;
            const modelName = document.getElementById('modelName').value;
            let apiKey = document.getElementById('apiKey').value;

            const maskedOriginal = getMaskedApiKey(originalApiKey);
            if (apiKey === maskedOriginal && originalApiKey) {
                apiKey = originalApiKey;
            } else if (isMaskedValue(apiKey) && originalApiKey) {
                apiKey = originalApiKey;
            }

            if (!apiUrl || !modelName || !apiKey) {
                showTestResult('请填写完整信息后再测试', 'error');
                return;
            }

            try {
                showTestResult('等待响应......', 'error');
                const testResult = await invoke('test_ai_connection', {
                    aiApiUrl: apiUrl,
                    aiModelName: modelName,
                    aiApiKey: apiKey
                });

                showTestResult(testResult, 'success');
            } catch (error) {
                showTestResult(`检查密钥、地址、模型名称是否正确。查看对应模型官方文档`, 'error');
            }
        });

        // 展示测试结果
        function showTestResult(message, type) {
            const resultDiv = document.getElementById('testResult');
            const resultIcon = resultDiv.querySelector('.test-result-icon');
            const resultText = resultDiv.querySelector('.test-result-text');

            if (type === 'success') {
                resultIcon.className = 'test-result-icon fas fa-check-circle';
            } else {
                resultIcon.className = 'test-result-icon fas fa-exclamation-circle';
            }

            resultText.textContent = message;

            resultDiv.className = `test-result ${type}`;
            resultDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 2000);
            }
        }

        // 检查更新功能
        document.getElementById('checkUpdateBtn').addEventListener('click', async () => {
            const checkUpdateBtn = document.getElementById('checkUpdateBtn');
            const originalText = checkUpdateBtn.innerHTML;

            try {
                checkUpdateBtn.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i> 检查中...';
                checkUpdateBtn.disabled = true;

                document.getElementById('updateResult').style.display = 'none';
                document.getElementById('updateProgress').classList.remove('hidden');

                resetUpdateProgress();

                const hasUpdate = await invoke('check_for_updates');

                if (hasUpdate) {
                    showUpdateResult('发现新版本，已开始下载更新', 'success');
                } else {
                    showUpdateResult('已是最新版本', 'success');
                    hideUpdateProgress();
                }
            } catch (error) {
                console.error('检查更新失败:', error);
                showUpdateResult(`检查更新失败请重试！`, 'error');
                hideUpdateProgress();
            } finally {
                checkUpdateBtn.innerHTML = originalText;
                checkUpdateBtn.disabled = false;
            }
        });

        // 关闭更新进度按钮事件
        document.getElementById('closeUpdateBtn').addEventListener('click', () => {
            hideUpdateProgress();
        });

        // 更新进度
        function resetUpdateProgress() {
            document.getElementById('statusText').textContent = '正在检查更新...';
            document.getElementById('updateActionButtons').classList.add('hidden');
        }

        // 隐藏更新进度
        function hideUpdateProgress() {
            document.getElementById('updateProgress').classList.add('hidden');
        }


        // 显示更新结果
        function showUpdateResult(message, type) {
            const resultDiv = document.getElementById('updateResult');
            const resultIcon = resultDiv.querySelector('.test-result-icon');
            const resultText = resultDiv.querySelector('.test-result-text');

            if (type === 'success') {
                resultIcon.className = 'test-result-icon fas fa-check-circle';
            } else {
                resultIcon.className = 'test-result-icon fas fa-exclamation-circle';
            }

            resultText.textContent = message;

            resultDiv.className = `test-result ${type}`;
            resultDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }

        // 主题切换功能
        document.getElementById('themeToggleBtn').addEventListener('click', () => {
            const body = document.body;
            const themeBtn = document.getElementById('themeToggleBtn');
            const icon = themeBtn.querySelector('.btn-icon');
            const text = themeBtn.querySelector('.theme-text');

            if (body.classList.contains('dark-theme')) {
                // 切换到白天主题
                body.classList.remove('dark-theme');
                icon.className = 'fas fa-moon btn-icon';
                text.textContent = '黑夜';
                localStorage.setItem('settings-theme', 'light');
            } else {
                // 切换到黑夜主题
                body.classList.add('dark-theme');
                icon.className = 'fas fa-sun btn-icon';
                text.textContent = '白天';
                localStorage.setItem('settings-theme', 'dark');
            }
        });

    });
</script>
</body>
</html>
